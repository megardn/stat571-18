---
title: "Predicting readmission probability for diabetes inpatients,  HW4 GROUP 18"
author:
- Diego G. Dávila
- Margaret Gardner
- Joelle Bagautdinova
date: 'Due before midnight, March 20'
output:
  html_document:
    code_folding: hide
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '4'
  word_document:
    toc: yes
    toc_depth: '4'
urlcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.width = 7, fig.height = 4)
if(!require("pacman")) install.packages("pacman")
pacman::p_load(dplyr, ggplot2, glmnet, car, data.table, skimr, GGally, ggpubr, tidyr, bestglm, pROC, caret)   #add your packages here
```


# Instructions

* This is a project. Well organized and well presented write-up is one major motivation here. Please see the section on `Write up` for details. 
* There is no single correct answer.  
* The entire write up should not be more than **5** pages. All the R-codes should be hidden. Any R-output used should be formatted neatly. You may put all supporting documents, graphics, or other exhibits into an Appendix, which is not counted in the 5 page limit.


# Introduction

## Background

Diabetes is a chronic medical condition affecting millions of Americans, but if managed well, with good diet, exercise and medication, patients can lead relatively normal lives. However, if improperly managed, diabetes can lead to patients being continuously admitted and readmitted to hospitals. Readmissions are especially serious - they represent a failure of the health system to provide adequate support to the patient and are extremely costly to the system. As a result, the Centers for Medicare and Medicaid Services announced in 2012 that they would no longer reimburse hospitals for services rendered if a patient was readmitted with complications within 30 days of discharge.

Given these policy changes, being able to identify and predict those patients most at risk for costly readmissions has become a pressing priority for hospital administrators. 

## Goal of the study

In this project, we shall explore how to use the techniques we have learned in order to help better manage diabetes patients who have been admitted to a hospital. Our goal is to avoid patients being readmitted within 30 days of discharge, which reduces costs for the hospital and improves outcomes for patients. If we could identify important factors relating to the chance of a patient being readmitted within 30 days of discharge, effective intervention could be done to reduce the chance of being readmitted. Also if we could predict one's chance being readmitted well, actions can be taken. 

As you all know, it is very important to present your findings well. To achieve the best possible results you need to understand your audience. 

Your target audience is a manager within the hospital organization. They hold an MBA, are familiar with medical terminology (though you do not need any previous medical knowledge), and have gone through a similar course to our Modern Data Mining with someone like your professor. You can assume thus some level of technical familiarity, but should not let the paper be bogged down with code or other difficult to understand output.

Note then that the most important elements of your report are the clarity of your analysis and the quality of your proposals. 


# Executive Summary

## Background

**Problem:** Diabetes is a chronic condition characterized by high blood sugar and is associated with important health concerns. In the U.S., diabetes is a major health care concern, as over 35 million (or 1 in 10) people are affected by this condition [CDC](https://www.cdc.gov/chronicdisease/programs-impact/pop/diabetes.htm). It also represents the nation's most expensive chronic condition, with over 237 billion dollars being spent annually on care for individuals with diabetes. Importantly, if diabetes is not detected/managed poorly, this can lead to serious health conditions and may cause the patient to undergo repeated hospital admissions, which in turn involves substantial costs. In addition, insurances no longer reimburse hospitals when patients are readmitted within 30 days, creating a strong incentive for hospitals to improve initial admission care and understand which factors may increase the risk of readmission within 30 days. 

**Solution:** The goal of this study is to determine which factors significantly impact the risk of readmission within 30 days. We address this question using a public dataset containing data collected from 70,000 patients with a total of 100,000 admissions over a period of 10 years (1999-2008) in 130 states, provided by the [Center for Clinical and Translational Research](https://archive.ics.uci.edu/ml/datasets/Diabetes+130-US+hospitals+for+years+1999-2008) at Virginia Commonwealth University. Here, we provide a brief summary of the data, followed by overview of the main findings. Finally, general conclusions and recommendations are made to improve care for diabetes and avoid short-term readmission (e.g., readmission within 30 days of discharge).


## Brief data summary

```{r load workspace}

# loading workspace containing all relevant R objects for faster knitting of executive summary
load("Mini_Project_Diabetes.RData")

```
  
To investigate factors associated with readmission within 30 days, we analyzed data from `r nrow(readmit_uniq)` unique patients' diabetes-related hospitalizations occurring between 1999 and 2008.Our dataset included: basic demographic information about the patients, such as age, gender and race; information about the hospitalization, such as what level of care they were admitted to and how long the were hospitalized for; counts of hospitalizations from the previous year; results from blood tests; changes in medications; and diagnoses.
  
Overall, around `r round(sum(readmit_uniq$readmit_30==1)/nrow(readmit_uniq)*100, 0)`% of patients admitted to a hospital had to be readmitted within 30 days. This indicates suboptimal care during the first admission event, leading to poorer health outcomes and increasing the risk of repeated hospitalizations. This also represents a heavy financial burden for hospitals, given that healthcare for these 7% of patients is not reimbursed by insurances. 


```{r plotting exec summary}
# bar plot showing readmit_30 proportions
ggplot(readmit_uniq, aes(x = readmit_30)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = readmit_30)) + 
  labs(title = "Readmission within 30 days", y="Percent")

```
  

## Method

Analyses were conducted using a method that identifies the most important factors in determining whether a patient will be readmitted within 30 days or not. The identified factors can either be: 

* Risk factors: when a patient presents with such a factor, their risk of readmission increases. 
* Protective factors: this type of factor reduces a patient's risk of readmission. 

## Main findings

Results indicate that the following factors increase the risk of readmission within 30 days:

* **Number of inpatient visits**: an individual with more inpatient visits during the year prior to the admission event has a higher risk of readmission within 30 days. 
* **Discharge location**: patients discharged at specialized care facilities are at higher risk of short-term readmission.
* **Age**: older individuals are more likely to require a short-term readmission. 

More specifically, the  number of inpatient hospitalizations in the previous year can be understood as a general health indicator, where individuals with poorer health generally will require more medical attention and thus present a higher risk of being readmitted within 30 days. Old age is similarly associated with poorer health and additionally implies a reduced ability to recover from acute diabetes complications, again increasing the risk of short-term readmission. Finally, the discharge location is an indirect indication of disease severity, where patients with poorer health conditions tend to be discharged at specialized care facilities. Given their generally poorer health state, these patients have an increased risk of short-term readmission. 

```{r plotting main findings, fig.width = 10, fig.height = 10}

# plotting age bins
p_age <- readmit_uniq %>%
  mutate(readmit_30 = as.factor(readmit_30)) %>% 
  mutate(readmit_30 = recode_factor(readmit_30, "0" = "No", "1" = "Yes")) %>%
  ggplot(aes(x = age_mod, fill = readmit_30)) + 
    geom_bar(aes(y = (..count..)/sum(..count..)), position = "dodge") + 
    labs(title = "Readmission by age groups", y="Percent")

# plotting discharge location
p_disch <- readmit_uniq %>%
  drop_na(disch_disp_modified) %>% #drop NAs before plotting 
  mutate(readmit_30 = as.factor(readmit_30)) %>% 
  mutate(readmit_30 = recode_factor(readmit_30, "0" = "No", "1" = "Yes"),
         disch_disp_modified = recode_factor(disch_disp_modified, "Discharged to home" = "Home", 
                                             "Discharged to home with Home Health Service" = "Home Health Service",
                                             "Discharged/Transferred to SNF" = "Skilled Nursing Facility",
                                             "Other" = "Other")) %>%
  ggplot(aes(x = disch_disp_modified, fill = readmit_30)) + 
    geom_bar(aes(y = (..count..)/sum(..count..)), position = "dodge") + 
    labs(title = "Readmission by discharge location", y="Percent")

# plotting number of inpatient visits
p_inpatient <- readmit_uniq %>%
  drop_na(number_inpatient) %>% #drop NAs before plotting 
  mutate(readmit_30 = as.factor(readmit_30)) %>% 
  mutate(readmit_30 = recode_factor(readmit_30, "0" = "No", "1" = "Yes")) %>%
  ggplot(aes(x = readmit_30, y = number_inpatient, fill = readmit_30, color = readmit_30)) + 
    geom_boxplot() + 
    labs(title = "Readmission by number of inpatient visits", 
         y = "Number of inpatient visits in the previous year")

# outputting plots
p_main_risk_factors <- ggarrange(p_age, p_inpatient, p_disch, ncol = 2, nrow = 2, common.legend = T)
annotate_figure(p_main_risk_factors, top = text_grob("Main factors impacting the risk of readmission within 30 days", face = "bold", size = 14))


```


```{r plotting predictions, fig.width = 10, fig.height = 10}

# get predicted probability of readmission at each value of age, holding inpatient visits and discharge location constant
age_pred <- with(readmit_uniq, data.frame(number_inpatient = mean(number_inpatient), 
                                          disch_disp_modified = levels(readmit_uniq$disch_disp_modified)[1],# keeping disch "constant"
                                                                                                            # (at reference level)
                                          age_mod = factor(levels(readmit_uniq$age_mod))
                                          ))

age_pred$age_prob <- predict(fit.logit.1, newdata = age_pred, type = "response")

# plotting
p_pred_age <- ggplot(age_pred, aes(x = age_mod, y = age_prob)) + 
  geom_line(aes(group = 1), color = "grey") +
  geom_point(color = "seagreen4", size = 5) +
  ggtitle("Predicted probability of readmission by age groups") 

# get predicted probability of readmission at each value of discharge location, holding inpatient visits and age constant
disch_pred <- with(readmit_uniq, data.frame(number_inpatient = mean(number_inpatient), 
                                          disch_disp_modified = factor(levels(readmit_uniq$disch_disp_modified)),
                                          age_mod = levels(readmit_uniq$age_mod)[1] # keeping age "constant" (at reference level)
                                          ))

disch_pred$disch_prob <- predict(fit.logit.1, newdata = disch_pred, type = "response")

# plotting
p_pred_disch <- disch_pred %>%
  mutate(disch_disp_modified = recode_factor(disch_disp_modified, "Discharged to home" = "Home", 
                                             "Discharged to home with Home Health Service" = "Home Health Service",
                                             "Discharged/Transferred to SNF" = "Skilled Nursing Facility",
                                             "Other" = "Other")) %>%
  ggplot(aes(x = disch_disp_modified, y = disch_prob)) + 
  geom_line(aes(group = 1), color = "grey") +
  geom_point(color = "seagreen4", size = 5) +
  ggtitle("Predicted prob. of readmission by discharge location") 


## get predicted probability of readmission at each value of inpatient visits, holding age and discharge location constant
# create new df
inpatient_pred <- with(readmit_uniq, data.frame(number_inpatient = rep(seq(from = 0, to = 15, length.out = 100), 16), # get 100 data points to get
                                                                                                                    # smooth line
                                    disch_disp_modified = factor(rep(levels(readmit_uniq$disch_disp_modified), each = 400)), # change level every 400 rows
                                    age_mod = factor(rep(levels(readmit_uniq$age_mod), each = 100)) # change level every 100 rows
                                    ))

inpatient_pred$inpatient_prob <- predict(fit.logit.1, newdata = inpatient_pred, type = "response")

# plotting
p_pred_inpatient <- ggplot(inpatient_pred, aes(x = number_inpatient, y = inpatient_prob)) +
  geom_smooth(color = "seagreen4") +
  ggtitle("Predicted probability of readmission by number of inpatient visits")

p_probs <- ggarrange(p_pred_age, p_pred_disch, p_pred_inpatient, ncol = 2, nrow = 2, common.legend = T) # nrow = 2,
annotate_figure(p_probs, top = text_grob("Predicted probaility of readmission within 30 days for each risk factor", face = "bold", size = 14))

```



## Limitations and conclusion

Our  model identified advanced age, number of inpatient hospitalizations within the past year, and discharge location as being predictive of readmission within 30 days. While many of these risk factors are not inherently modifiable, they can be used to target individuals for additional support. Post-discharge outpatient care and educating patients about disease management could be cost-effective ways to reduce readmission in at-risk patients, including those over the age of 60 and those with a history of recent inpatient admissions. The fact that discharge to home appears to be protective of readmission may reflect the relative lack of disease severity in these patients, but may also provide an interesting avenue of further research to explore what type of post-discharge supports the prevention of readmission.

One important limitation of our study is the predictive ability of our model itself; while it predicted readmission well in the training dataset it was built on, prediction error was higher in an independent validation sample. Other limitations of our study include lack of predictors that were either not captured in the study, such as medical insurance information and patients' socioeconomic status, or not useable due to incompleteness, such as blood tests. Furthermore, [the hospitals sampled are not evenly distributed across the United States](https://www.hindawi.com/journals/bmri/2014/781670/#supplementary-materials), with a strong over representation of Northeastern states, potentially limiting generalizability.

# Detailed process of the analysis

## Data Summary /EDA

These data were collected by the [Center for Clinical and Translational Research](https://archive.ics.uci.edu/ml/datasets/Diabetes+130-US+hospitals+for+years+1999-2008) at Virginia Commonwealth University from 130 hospitals between 1999 and 2008. A detailed description of each variable and the initial data cleaning, undertaken by course instructors, is provided in the Appendix below. 

### Numerical summary 

After initial cleaning, our dataset contained the following:

```{r num.eda}
#read in `readmission.csv` as `readmit_data`
readmit_data <- read.csv("readmission.csv", header=T, na.strings= c("?", "None", "Unknown/Invalid"), stringsAsFactors = T)

#recode encounter_id and patient_nbr as factor
readmit_data <- readmit_data %>% mutate(encounter_id = as.factor(encounter_id),
                                        patient_nbr = as.factor(patient_nbr),
                                        readmit_30 = as.factor(ifelse(readmitted == '<30', 1, 0)))

# str(readmit_data) 
# summary(readmit_data)
skim(readmit_data)
```

We removed the `A1Cresult` and `max_glu_serum` variables since there the majority of rows contain missing values (0.05% and 0.1% non-NA values in `max_glu_serum` and `A1Cresult`, respectively). Few other variables seem to be missing from our dataset.
 
```{r}
# dropping variables with mostly NAs
readmit_data <- readmit_data %>%
  select(-c(A1Cresult, max_glu_serum))
```

We are also adding a variable encoding the cumulative number of admissions per patient (`nb_admissions`). While this variable cannot include hospitalizations that were not captured by the team, either because they were outside of the 130 hospitals sampled or prior to 1999, this will provide a longer overview of a particular patients' health leading up to the admission than the 1-year snapshots collected in the original dataset.

```{r}
readmit_data <- readmit_data %>%
  arrange(patient_nbr, encounter_id) %>%
  group_by(patient_nbr) %>%
  mutate(nb_admissions = rep(seq(n()))) %>%
  ungroup()
  # summarise(total_nb_admissions = n()) # total nb admissions

skim(readmit_data[["nb_admissions"]])

```


### Visual summary

Because logistic regression depends on observations being independent, we subsetted by selecting only one random hospitalization for each individual patient. We will perform further EDA and further modelling on this subsetted sample.

```{r}
#filter unique pt's random hospitalizations
set.seed(100) #seed for reproducibility
readmit_uniq <- readmit_data %>% 
   group_by(patient_nbr) %>%
   sample_n(1) %>%
  ungroup()

str(readmit_uniq)
sum(readmit_uniq$readmit_30==1)/nrow(readmit_uniq)

#quick plot to see differences between readmission among all data and unique pt subset
p1 <- ggplot(readmit_data, aes(x=readmitted)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = readmitted)) + 
  ylim(0, 0.75) +
  labs(title = "Readmission in full dataset", y="Percent") +
  theme(plot.title = element_text(size=15))
p2 <- ggplot(readmit_uniq, aes(x=readmitted)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = readmitted)) + 
  ylim(0, 0.75) +
  labs(title = "Readmission in random subset", y="Percent") +
  theme(plot.title = element_text(size=15))
p3 <- ggplot(readmit_data, aes(x = readmit_30)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = readmit_30)) + 
  labs(title = "Readmission within 30 days in full dataset", y="Percent") +
  theme(plot.title = element_text(size=15))
p4 <- ggplot(readmit_uniq, aes(x = readmit_30)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = readmit_30)) + 
  labs(title = "Readmission within 30 days in random dataset", y="Percent") +
  theme(plot.title = element_text(size=15))

ggarrange(p1, p2, ncol = 2, common.legend = T)
ggarrange(p3, p4, ncol = 2, common.legend = T)
```

We can observe that:
* around 10% of the full sample is readmitted within 1 month
* around 7% of the latest hospital admission is readmitted within 1 month

Further exploratory visualizations are performed to obtain an initial sense of which variables may play a role in whether patients are readmitted within 30 days or not:

```{r visualizing readmit_30 and other variables}
# plotting gender
readmit_uniq %>%
  filter(gender == "Female" | gender == "Male") %>%
  ggplot(aes(x = readmit_30)) + 
    geom_bar(aes(y = (..count..)/sum(..count..), fill = readmit_30)) + 
    facet_wrap(~gender) +
    labs(title = "Readmission within 30 days by gender", y="Percent")

# plotting age bins
readmit_uniq %>%
  ggplot(aes(x = readmit_30)) + 
    geom_bar(aes(y = (..count..)/sum(..count..), fill = readmit_30)) + 
    facet_wrap(~age_mod) +
    labs(title = "Readmission within 30 days by age bins", y="Percent")

# plotting race
readmit_uniq %>%
  drop_na(race) %>% #drop NAs before plotting 
  ggplot(aes(x = readmit_30)) + 
    geom_bar(aes(y = (..count..)/sum(..count..), fill = readmit_30)) + 
    facet_wrap(~race) +
    labs(title = "Readmission within 30 days by race", y="Percent")


# plotting medications
readmit_uniq %>% 
  tidyr::pivot_longer(cols = metformin:insulin, 
               names_to = "Medication",
               values_to = "Trend") %>% 
  ggplot(aes(Trend, Medication, fill = readmit_30)) + 
    geom_bar(aes(y = (..count..)/sum(..count..)), position = "dodge") + 
    facet_wrap(~Medication) +
    labs(title = "Readmission within 30 days by medication trends", y="Percent")

# plotting change in rx
readmit_uniq %>%
  drop_na(change) %>% #drop NAs before plotting 
  ggplot(aes(x = readmit_30)) + 
    geom_bar(aes(y = (..count..)/sum(..count..), fill = readmit_30)) + 
    facet_wrap(~change) +
    labs(title = "Readmission within 30 days by change in diabetes", y="Percent")

# plotting discharge location
readmit_uniq %>%
  drop_na(disch_disp_modified) %>% #drop NAs before plotting 
  ggplot(aes(x = readmit_30)) + 
    geom_bar(aes(y = (..count..)/sum(..count..), fill = readmit_30)) + 
    facet_wrap(~disch_disp_modified) +
    labs(title = "Readmission within 30 days by discharge location", y="Percent")

```


```{r, fig.width = 10, fig.height = 10, warning=FALSE, message=FALSE}
# numerical variables
readmit_uniq %>% 
  select(readmit_30, time_in_hospital, num_lab_procedures, num_procedures, num_medications, 
         number_outpatient, number_inpatient, number_emergency, nb_admissions, number_diagnoses) %>% 
  ggpairs(aes(color = readmit_30))
```

Based on the above plots, readmissions within 30 days may potentially occur more frequently in 60-70 year old patients and in Caucasian patients, although it should be noted that the sample contains an overrepresentation of the Caucasian population in general. Numerical variables do not show clear differences between patients who are and aren't readmitted within 30 days.  

	
## Analyses

1) First we sought to identify important factors that capture the chance of a readmission within 30 days by creating a model that would describe our dataset. To do so, we subdivided our dataset into `data.train`(60%), `data.test` (20%), and `data.val` (20%), for the most rigorous model evaluation.

```{r}
# Split the data 
N <- length(readmit_uniq$patient_nbr)
n1 <- floor(.6*N)
n2 <- floor(.2*N)

set.seed(10)

# Split data to three portions of .6, .2 and .2 of data size N
idx_train <- sample(N, n1)
idx_no_train <- (which(! seq(1:N) %in% idx_train))
idx_test <- sample(idx_no_train, n2)
idx_val <- which(! idx_no_train %in% idx_test)
data.train <- as.data.frame(readmit_uniq[idx_train,])
data.test <- as.data.frame(readmit_uniq[idx_test,])
data.val <- as.data.frame(readmit_uniq[idx_val,])
``` 

To determine which factors play a role in patient readmission < 30 days, we use a `LASSO` approach (`cv.glmnet()`) where the deviance is minimized. Note that rows with NAs are omitted in this process given that the LASSO function does not tolerate these. We will use the training dataset to build the model and the validation subset to evaluate our final model. Because we are using LASSO to select our predictors, a testing dataset will not be necessary, and so we'll incorporate these data points into the training dataset for this test.

```{r run LASSO}
#remove columns we don't want to include as predictors or y
data.train.lasso <- rbind(data.train, data.test)
readmit_mod <- data.train.lasso %>% 
  select(!c(encounter_id, patient_nbr, readmitted)) %>% # removing patient and admission IDs as well as irrelevant readmitted variable
  na.omit() # omitting NAs as LASSO does not accept these (and model.matrix also removes them by default)

# generate matrices for LASSO
Y <- as.matrix(readmit_mod[, "readmit_30"]) # extract Y and transform to matrix for LASSO to work
X <- model.matrix(readmit_30 ~., data = readmit_mod)[, -1]  # for each factor: num of levels -1

set.seed(100)  # seed for reproducibility 

# run LASSO
fit.readmit.cv <- cv.glmnet(X, Y,  alpha = 1, family = "binomial", nfolds = 10, type.measure = "deviance")

# plotting
plot(fit.readmit.cv)

fit.readmit.cv$lambda.1se # use lambda.1se to select the smaller model
coef.1se <- coef(fit.readmit.cv, s = "lambda.1se") # get coefficients
coef.1se <- coef.1se[which(coef.1se != 0),] # show variables with non-zero coefficients
var.1se <- rownames(as.matrix(coef.1se))[-1] # output variable names without interceptt
var.1se
```

Now we use the predictors identified to build our model on the LASSO training subset.

```{r LASSO model}
# let's first select the variables identified through LASSO - for now dropping factor levels and readding full variable
var.1se <- var.1se[-grep("disch_disp_modified|age_mod", var.1se)] # remove factor levels
var.1se <- append(var.1se, c("disch_disp_modified", "age_mod")) # replace levels with full factors
data.train.lasso.m <- data.train.lasso %>%
  select(c(var.1se, "readmit_30"))

# fit glm with LASSO-identified variables
fit.logit.1 <- glm(readmit_30 ~ ., family = binomial, data = data.train.lasso.m)

# check significance of variables
Anova(fit.logit.1)
summary(fit.logit.1)
```

All variables are significant! It seems based on our data that the time spent in the hospital, number of previous inpatient admissions, number of diagnoses, where a patient is discharged to after treatment, and age are significant predictors of an individual's chances of readmission within 30 days. Each predictor identified also makes sense logically: increased age would be correlated with disease severity and the ability to recover from acute diabetes complications; the  number of inpatient hospitalizations in the previous year would also correlate with overall health status and disease severity; finally, the discharge location is an indirect indication of disease severity, where patients with poorer health conditions tend to be discharged at specialized care facilities. Given their generally poorer health state, these patients have an increased risk of short-term readmission. 

We'll build another model using bestglm to test against our LASSO model. Since bestglm accepts an upper limit of 15 predictors, we'll subset the training data to 15 predictors (including factor levels) based on our EDA and a prior knowledge. `Race` and `age_mod` were included due to the observed potential associations of Race=Caucasian and age_mod=60-70 yrs, respectively,  with readmission in our EDA; `gender` was included as part of biomedical convention, as sex differences have been observed in many diseases and can have large consequences for public health; and `num_medications` was chosen as a proxy for disease severity, as patients requiring more medications during hospitalization likely suffer a more severe or complex form of disease and may be more likely to relapse.

```{r bestglm}
# mod data.train
data.train.m <- data.train %>% 
  select(c("readmit_30", "race", "gender", "age_mod", "num_medications")) %>%
  na.omit() # omitting NAs (model.matrix also removes them by default)

# Get the design matrix without 1's and HD
Xy_design <- model.matrix(readmit_30 ~.+0, data.train.m) #+0 -> no intercept, gets rid of first col with 1s
# Attach y as the last column.
Xy <- data.frame(Xy_design, data.train.m$readmit_30)   
fit.glm <- bestglm(Xy, family = binomial, method = "forward", IC="AIC") #using forward selection for efficiency
fit.glm$BestModels
fit.glm$BestModel

# check significance of predictors in BestModel on data.test
fit.glm.1 <- glm(readmit_30~race+age_mod+num_medications, family=binomial, data=data.test)
summary(fit.glm.1)
Anova(fit.glm.1)
```

`Race` is not significant so we will remove it from the model.

``` {r bestglm model}
fit.glm.final <- glm(readmit_30~age_mod+num_medications, family=binomial, data=data.test)
Anova(fit.glm.final)
summary(fit.glm.final)$dispersion
```


2) Now we'll compare the bestglm and LASSO models' on AUC/ROC to see which one is best for predicting whether a patient will be a readmit within 30 days. 

```{r model.comp}
#plot ROC & AUC
fit.glm.final.roc <- roc(data.test$readmit_30, fit.glm.final$fitted) #bestglm model on data.test
fit.logit.1.roc <- roc(data.train.lasso$readmit_30, fit.logit.1$fitted) #LASSO model on data.train.lasso
plot(1-fit.glm.final.roc$specificities, 
     fit.glm.final.roc$sensitivities, col="red", lwd=3, type="l",
     xlab="False Positive", 
     ylab="Sensitivity")
lines(1-fit.logit.1.roc$specificities, fit.logit.1.roc$sensitivities, col="blue", lwd=3)
legend("bottomright",
       c(paste0("fit.glm.final (bestglm) AUC=", round(fit.glm.final.roc$auc,2)), 
         paste0("fit.logit.1 (LASSO) AUC=", round(fit.logit.1.roc$auc, 2))),
       col=c("red", "blue"),
       lty=1)

```

The ROC curve and AUC clearly indicate that our final LASSO model is superior to the bestglm model across thresholds. We'll next compare prediction using starting with a threshold our probability of readmission at 1/2. 

```{r confusion}
#run classification on LASSO model
fit.pred.1 <- ifelse(fit.logit.1$fitted > 1/2, "1", "0")
#confusion matrix
confusionMatrix(data = as.factor(fit.pred.1),         # predicted value
                       reference = data.train.lasso.m$readmit_30,              # true results as reference
                       positive = levels(data.train.lasso.m$readmit_30)[2])    # readmission level

#run classification on bestglm model
fit.pred.2 <- ifelse(fit.glm.final$fitted > 1/2, "1", "0")
#confusion matrix
confusionMatrix(data = as.factor(fit.pred.2),         # predicted value
                       reference = data.test$readmit_30,              # true results as reference
                       positive = levels(data.test$readmit_30)[2])    # readmission level

#getting:
## Warning in confusionMatrix.default(data = as.factor(fit.pred.2), reference = data.test$readmit_30,  :
##   Levels are not in the same order for reference and data. Refactoring data to match.
#tried outputting prediction simplified - dont think the factors are out of order...?
output1 <- data.frame(data.test$readmit_30, fit.pred.2, fit.glm.final$fitted)[sample(14303, 10),] 
names(output1) <- c( "Readmission", "Predicted Readmission", "Prob")
output1
```

Comparing on a threshold of 1/2 again confirms that the LASSO-generated model is superior on sensitivity (0.008 vs 0). While the bestglm model has better specificity (1 vs 0.999), it failed to identify any cases of readmission and the LASSO model's specificity was also very high. Based on its superior ROC, AUC, and balance of sensitivity and specificity, we will proceed with the LASSO-generated model as our final predictive model.

Next we'll choose threshold that balances sensitivity and specificity of our model. We choose a model with sensitivity of ~60% to maximize our chances of identifying patients at risk for readmission. While this will increase the false positive rate, potentially causing hospitals to spend additional money caring for patients who would not have been readmitted, this is preferable from a health-standpoint.

``` {r threshold}
#find threshold
sense.60 <- fit.logit.1.roc$sensitivities[15]
coords(fit.logit.1.roc, sense.60, input="sensitivity", ret=c("threshold", "specificity", "sensitivity"))

#rerun classification with new threshold
fit.pred.3 <- ifelse(fit.logit.1$fitted > 0.0659, "1", "0")
#confusion matrix
confusionMatrix(data = as.factor(fit.pred.3),         # predicted value
                       reference = data.train.lasso.m$readmit_30,              # true results as reference
                       positive = levels(data.train.lasso.m$readmit_30)[2])    # readmission level
```

3) Provided estimates indicate that **it costs twice as much** to mislabel a readmission than it does to mislabel a non-readmission; therefore we propose a specific classification rule to minimize the cost.

Bayes' rule can be used as a classification rule to minimize the cost according to specific weights. Assuming the cost of misclassifying "1" to "0" is 2 times of that of misclassifying "0" to "1",
then the Bayes rule is thresholding over the 
$$\hat P(Y=1 \vert x) > \frac{0.5}{(1+0.5)}=0.333$$ 

Therefore we'll use Bayes thresholding on our final model:

```{r Bayes rule}
# Applying Bayes rule
fit.logit.1.bayes <- ifelse(fit.logit.1$fitted > .333, "1", "0")
fit.logit.bayes.f <- as.factor(fit.logit.1.bayes)

#calculate MCE
MCE.bayes <- (2 * sum(fit.logit.bayes.f[data.train.lasso.m$readmit_30 == "1"] != "1") 
                      + sum(fit.logit.bayes.f[data.train.lasso.m$readmit_30 == "0"] != "0"))/length(data.train.lasso.m$readmit_30)
MCE.bayes 

#confusion matrix with new threshold
confusionMatrix(data = as.factor(fit.logit.1.bayes),         # predicted value
                       reference = data.train.lasso.m$readmit_30,              # true results as reference
                       positive = levels(data.train.lasso.m$readmit_30)[2])    # readmission level
```

The predictions returned via our Bayes rule threshold have much lower sensitivity (0.02 vs 0.60) but also much higher specificity (0.99 vs 0.63) than our 60% specificity model.

4) Finally, we evaluate our final model with the validation data to give an honest assessment of its predictive ability. To do so, we will calculate AUC and MCE on our `data.val` subset and threshold our classification at 33.3% risk, per Bayes rule.


```{r validation}
#calculate AUC
fit.logit.val <- predict(fit.logit.1, data.val, type="response")
pROC::auc(data.val$readmit_30, fit.logit.val)

#calculate MCE
MCE.val <- (2 * sum(fit.logit.bayes.f[data.val$readmit_30 == "1"] != "1") 
                      + sum(fit.logit.bayes.f[data.val$readmit_30 == "0"] != "0"))/length(data.val$readmit_30)
MCE.val
```

```{r save workspace}

# saving workspace containing all generated objects for faster knitting of executive summary above
save.image("Mini_Project_Diabetes.RData")

```

Our model fits the validation data similarly to the training data with AUC=0.648. However, our MCE is higher (0.498), indicating our model is more likely to misclassify individuals in the validation dataset than the training dataset. 

# Conclusion

Our  model identified advanced age, number of inpatient hospitalizations within the past year, and discharge location as being predictive of readmission within 30 days. While many of these risk factors are not inherently modifiable, they can be used to target individuals for additional support. Post-discharge outpatient care and educating patients about disease management could be cost-effective ways to reduce readmission in at-risk patients, including those over the age of 60 and those with a history of recent inpatient admissions. 

In particular, our model indicates that patients who are readmitted to inpatient care are most likely to require readmission within 30 days. This could be an indication of greater disease severity in these individuals, requiring frequent hospitalization, but could also be influenced by the ability of patients to manage their disease outside the hospital. As a chronic condition, diabetes requires vigilant symptom management on the part of patients. One could imagine that patients who do not have access to regular blood-glucose testing or healthy food options may struggle to keep symptoms under control, leading to readmission. Similarly, access to stable and regular outpatient care could support patients in managing their symptoms and provide monitoring from providers who could intervene before a patient would require hospitalization. While one may argue that this is counter to our finding that discharge to home is protective against readmission, there are several possible explanations. Firstly, patients with less severe disease are more likely to be discharged home than more critically ill patients, reducing the overall incidence of readmission in home-discharged individuals. Furthermore, our data does not capture any of the benefits that individuals discharged to home may have, including outpatient provider access or strong family supports. Future studies could explore this possibility by surveying patient attitudes towards and knowledge about diabetes management, access to necessary medical supplies and nutrition options, and support of family and medical providers.

One important limitation of our study is the predictive ability of our model itself; while it had a low misclassification error rate (MCE) in the training dataset (`r MCE.bayes`) , the MCE was higher in our validation sample (`r MCE.val`). While some discrepancy is expected given the expected variability of individuals between datasets, this does limit the strength of our model and recommendations. 

Other limitations of our study include missing data points, particularly among biological measures such as serum glucose and HbA1c, which could provide direct and unbiased assessments of patients' diabetes severity. HbA1c in particular is indicative of blood glucose levels over several months and could provide important insight into the health status of individuals at readmission. Other potentially important predictors include medical insurance information and patients' socioeconomic status, which unfortunately can have strong determinations in a patients' access to care and therefore can potentially predict health status. Finally, while the dataset is large, [the hospitals sampled are not evenly distributed across the United States](https://www.hindawi.com/journals/bmri/2014/781670/#supplementary-materials), with a strong over representation of Northeastern states. Therefore, these results could be disproportionately influenced by the healthcare environment of the Northeast (including treatment norms, insurance standards, or state law) and should be generalized with caution. 

# Appendix
	
### Initial Data Cleaning and Description of Variables

The following descriptions were provided by the course instructors, who also undertook initial data cleaning. Three former students Spencer Luster, Matthew Lesser and Mridul Ganesh, identified the original dataset, which includes the following variables:

**1) Patient identifiers:** 
a. `encounter_id`: unique identifier for each admission 
b. `patient_nbr`: unique identifier for each patient 
**2) Patient Demographics:** 
`race`, `age`, `gender`, `weight` cover the basic demographic information associated with each patient. `Payer_code` is an additional variable that identifies which health insurance (Medicare /Medicaid / Commercial) the patient holds.
**3) Admission and discharge details:** 
a.	`admission_source_id` and `admission_type_id` identify who referred the patient to the hospital (e.g. physician vs. emergency dept.) and what type of admission this was (Emergency vs. Elective vs. Urgent). 
b.	`discharge_disposition_id` indicates where the patient was discharged to after treatment.
**4) Patient Medical History:**
a.	`num_outpatient`: number of outpatient visits by the patient in the year prior to the current encounter
b.	`num_inpatient`: number of inpatient visits by the patient in the year prior to the current encounter
c.	`num_emergency`: number of emergency visits by the patient in the year prior to the current encounter
**5)	Patient admission details:**
a.	`medical_specialty`: the specialty of the physician admitting the patient
b.	`diag_1`, `diag_2`, `diag_3`: ICD9 codes for the primary, secondary and tertiary diagnoses of the patient.  ICD9 are the universal codes that all physicians use to record diagnoses. There are various easy to use tools to lock up what individual codes mean (Wikipedia is pretty decent on its own)
c.	`time_in_hospital`: the patient’s length of stay in the hospital (in days)
d.	`number_diagnoses`: Total no. of diagnosis entered for the patient
e.	`num_lab_procedures`: No. of lab procedures performed in the current encounter
f.	`num_procedures`: No. of non-lab procedures performed in the current encounter
g.	`num_medications`: No. of distinct medications prescribed in the current encounter
**6)	Clinical Results:**
a.	`max_glu_serum`: indicates results of the glucose serum test
b.	`A1Cresult`: indicates results of the A1c test
**7)	Medication Details:**
a.	`diabetesMed`: indicates if any diabetes medication was prescribed 
b.	`change`: indicates if there was a change in diabetes medication
c.	`24 medication variables`: indicate whether the dosage of the medicines was changed in any manner during the encounter
**8)	Readmission indicator:** 
Indicates whether a patient was readmitted after a particular admission. There are 3 levels for this variable: "NO" = no readmission, "< 30" = readmission within 30 days and "> 30" = readmission after more than 30 days.

The course instructors completed the first level of data cleaning, as described below:

1) `Payer code`, `weight` and `Medical Specialty` were removed since they have a large number of missing values. 
2) Variables such as `acetohexamide`, `glimepiride.pioglitazone`, `metformin.rosiglitazone`, `metformin.pioglitazone` had little variability, and are as such excluded. This also includes the following variables: `chlorpropamide`, `acetohexamide`, `tolbutamide`, `acarbose`, `miglitor`, `troglitazone`, `tolazamide`, `examide`, `citoglipton`, `glyburide.metformin`, `glipizide.metformin`, and `glimepiride.pioglitazone`.
3) Some categorical variables were binned For example, `Diag1_mod` keeps some original levels with large number of patients and aggregates other patients as `others`.
